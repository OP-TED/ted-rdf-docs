:doctitle: SPARQL Queries
:doccode: sws-main-prod-025
:author: NPJ
:authoremail: nicole-anne.paterson-jones@ext.ec.europa.eu
:docdate: October 2023


In the context of TED-SWS, SPARQL queries can be used to query the data of notices published in RDF by the Publications Office.  These queries can be made on the
https://publications.europa.eu/webapi/rdf/sparql[SPARQL end point] available in EU Vocabularies

SPARQL queries refer to a specialized query language designed for retrieving and manipulating data stored in RDF (Resource Description Framework) format. SPARQL stands for SPARQL Protocol and RDF Query Language. It allows users to write complex queries to retrieve specific information from RDF datasets.

The data available covers Contract Award Notices published after 28/08/2023.  Data on eForm Result notices are not available yet.

A query is submitted to the SPARQL end point by replacing the text highlighted below in blue in the Query Text box below with your query:

image:sparql.png[SPARQL End Point]

The format of the result can be changed using the drop down box of the Results format.



Once the query is in place, and the Results format chosen, the query can be run by pressing “Run Query”


Below you will find an example of a query:

////

=== BQ 1. How many contractors are SMEs for a given country and given date?

[source,sparql]
PREFIX epo: <http://data.europa.eu/a4g/ontology#>
PREFIX cccev: <http://data.europa.eu/m8g/>
SELECT COUNT DISTINCT(?Notice) WHERE {
    VALUES (?PublicationDate ?countryCode ?businessSize) {
            ("20230905"
            <http://publications.europa.eu/resource/authority/country/DEU>
            <http://publications.europa.eu/resource/authority/economic-operator-size/sme>)
    }
    ?Notice epo:hasPublicationDate ?NoticePublicationDate .
    ?Notice epo:announcesRole ?Buyer .
    ?Buyer epo:playedBy ?Organization .
    ?Oganization epo:hasBusinessSize ?businessSize .
    ?Organization cccev:registeredAddress / epo:hasCountryCode ?countryCode .
}

This SPARQL query aims to count the number of distinct procurement notices that meet specific criteria related to publication date, country code (Germany), and business size (SME).
////



=== Query:  Which notices have been published by Buyers from a specific country for a given date?


This SPARQL query retrieves information about contract award notices that have been published by buyers from Germany and published on TED on 05-09-2023.

The query retrieves:

* The ID of the resource which contains the Notice ID

* The URI of the organisation within the notice

* The name of the buyer.

It does so by specifying a set of values and then querying the RDF data based on those values. The query returns information about the notices, the organizations (buyers), and their legal names.

The date and country can be changed to create other queries.

* To change the date, change the value:

VALUES (?PublicationDate ?countryCode) {

            ("20230905"

* To change the country change the value:

<http://publications.europa.eu/resource/authority/country/DEU>

[source,sparql]
PREFIX epo: <http://data.europa.eu/a4g/ontology#>
PREFIX cccev: <http://data.europa.eu/m8g/>
PREFIX org: <http://www.w3.org/ns/org#>
SELECT DISTINCT
?Notice
?Organization
?LegalName
WHERE {
    VALUES (?PublicationDate ?countryCode) {
            ("20230905" <http://publications.europa.eu/resource/authority/country/DEU>)
    }
    ?Notice epo:hasPublicationDate ?PublicationDate .
    ?Notice epo:announcesRole ?Buyer .
    ?Buyer epo:playedBy ?Organization .
    ?Organization cccev:registeredAddress / epo:hasCountryCode ?countryCode .
    ?Organization epo:hasLegalName ?LegalName .
}


////

=== BQ 2. Who are the winners for a given date?

[source,sparql]
PREFIX epo: <http://data.europa.eu/a4g/ontology#>
PREFIX org: <http://www.w3.org/ns/org#>
PREFIX cccev: <http://data.europa.eu/m8g/>
select distinct
?Lot
?Winner
?WinnerCountryCode
?LotAwardetAmountValue
?LotAwardetValueCurrency
where {
    values ?NoticePublicationDate {
       "20230921"
    }
    ?NoticeId a epo:ResultNotice;
                   epo:hasPublicationDate ?NoticePublicationDate;
                   epo:refersToLot ?Lot.
    ?Lot a epo:Lot.
    ?LotAwardOutcome epo:describesLot ?Lot;
                   a epo:LotAwardOutcome;
                   epo:comprisesTenderAwardOutcome ?TenderAwardOutcome.
    ?TenderAwardOutcome a epo:TenderAwardOutcome;
                          epo:indicatesAwardOfLotToWinner / epo:playedBy ?Winner.
    ?Winner a org:Organization.
    optional {
        ?Winner cccev:registeredAddress / epo:hasCountryCode ?WinnerCountryCode.
    }
    ?LotAwardOutcome epo:hasAwardedValue ?LotAwardetValue.
    ?LotAwardetValue a epo:MonetaryValue;
                epo:hasAmountValue ?LotAwardetAmountValue;
                epo:hasCurrency ?LotAwardetValueCurrency.
}

This SPARQL query aims to retrieve information about the winners of procurement lots for a specific date ("20230921" or 21-09-2023). It does so by specifying a value for the publication date, and then querying the RDF data based on that value. The query returns information about the lots, the organizations that won them, and details about the awarded amounts and currencies.


=== BQ 4. Which is the highest value published for a contract award for a given date?

[source,sparql]
PREFIX epo: <http://data.europa.eu/a4g/ontology#>
SELECT
?Notice
?NoticePublicationDate
?Lot
?AmmountValue
?CurrencyCode
WHERE {
    VALUES ?Date {
        "20230905"
    }
    ?Notice epo:hasPublicationDate ?NoticePublicationDate .
    ?Notice epo:refersToLot ?Lot .
    ?LotAwardOutcome epo:describesLot ?Lot .
    ?LotAwardOutcome epo:hasAwardedValue ?MonetaryValue .
    ?MonetaryValue a epo:MonetaryValue;
        epo:hasAmountValue ?AmmountValue;
        epo:hasCurrency ?CurrencyCode .
}
ORDER BY DESC(?AmmountValue)
LIMIT 1

This SPARQL query aims to retrieve the procurement notice, its publication date, the corresponding lot, and the highest awarded amount along with the currency code for a specific date ("20230905" or 05-09-2023). It does so by specifying a value for the date and then querying the RDF data based on that value. The query returns the information in descending order of the awarded amount, with only the highest value being displayed.

NOTE: Other examples of SPARQL queries can be found https://github.com/OP-TED/ted-rdf-docs/tree/main/queries[here].


== Querying data using Virtuoso SPARQL Endpoint

Virtuoso SPARQL Endpoint refers to a specific type of web service provided by Virtuoso, which is a high-performance, scalable, and feature-rich RDF database and SPARQL query engine. It provides a means to interact with the RDF data representing TED notices, allowing users to perform advanced querying and analysis tasks on the procurement information available in the system. It can be accessed https://publications.europa.eu/webapi/rdf/sparql[here].

The following instruction explains how to query Virtuoso SPARQL Query Endpoint using a query from the examples above:

. Copy an example of query and access Virtuoso SPARQL Query endpoint Webpage

. As shown in _Figure 1_, Insert the query in the "Query Text" box and press "Run Query" button

.Querying TED-SWS data using Virtuoso SPARQL Query endpoint
image::user_manual/sparql_queries/image1.png[image,width=601,height=84]

The result of the query is displayed as a data table (_Figure 2_).

.Query result table
image::user_manual/sparql_queries/image2.png[image,width=801,height=84]
////

include::partial$feedback.adoc[]