:doctitle: Jupyter Notebook - Python
:doccode: sws-main-prod-021
:author: NPJ
:authoremail: nicole-anne.paterson-jones@ext.ec.europa.eu
:docdate: October 2023


This document shows an example using the Jupyter Notebook in Python. The
Jupyter Notebook is an application for creating and sharing
computational documents. Python represents a programming language for
writing computational documents. To realize the proposed scenario, it is
necessary to install the special tools and use the Python code that will
perform a query to the cellar and display the results in tabular
form.

To run the sample application using Python language follow the steps below:

[arabic]
. https://github.com/OP-TED/ted-rdf-docs/blob/main/notebooks/query_cellar_python.ipynb[Download Jupyter Notebook ]


[arabic, start=2]
. Download & Install Python 3.8
[loweralpha]
.. Windows 64bit:
https://www.python.org/ftp/python/3.8.10/python-3.8.10-amd64.exe[[.underline]#download#]

.. Windows 86bit:
https://www.python.org/ftp/python/3.8.10/python-3.8.10.exe[[.underline]#download#]

. Open the Jupyter Notebook file with the code editor

. In the code editor, select the Python interpreter that was installed in the previous step

.Interpreter selection
image::user_manual/jupyter_notebook/image1.png[image,width=817,height=204]


[arabic, start=5]
. Install dependencies

* Use OS command line and run the following command

[source, python]
pip3 install sparqlwrapper pandas Jinja2 matplotlib

NOTE: After installation, restart kernel from Jupyter Notebook to update it with new dependencies. This can be done by clicking on the "Restart" button in your code editor.

[arabic, start=6]
. Run all Jupyter Notebook Cells

.Button that runs all cells
image::user_manual/jupyter_notebook/image2.png[image,width=501,height=84]

[arabic, start=7]
. After running successfully all the cells in the Jupyter Notebook, we can see the result table

.Result table
image::user_manual/jupyter_notebook/image3.png[image,width=987,height=420]

== Explaining the query

**Question: Who are the winners for a given date?**

This SPARQL query aims to retrieve information about the winners of procurement lots for a specific date ("20230921" or 21-09-2023). It does so by specifying a value for the publication date, and then querying the RDF data based on that value. The query returns information about the lots, the organizations that won them, and details about the awarded amounts and currencies.

This query is composed of:

* The Prefix section is used to define short aliases (prefixes) for long URIs (Uniform Resource Identifiers).

    PREFIX epo: <http://data.europa.eu/a4g/ontology#>
    PREFIX org: <http://www.w3.org/ns/org#>
    PREFIX cccev: <http://data.europa.eu/m8g/>

* The Select section is responsible for specifying which variables or values are to be retrieved from the dataset.

    SELECT DISTINCT
    ?Lot
    ?WinnerLegalName
    ?WinnerCountryCode
    ?AwardedValue
    ?AwardedValueCurrency

* The Where section is used to define the specific patterns and conditions that the data in the dataset must match in order to be included in the query result. In this example we have:

** Specifying specific filters for output

    VALUES ?NoticePublicationDate {
        "20230921"
    }
    FILTER(LANG(?WinnerLegalName) = 'en')

** Defining notice according to EPO ontology

    ?NoticeId a epo:ResultNotice;
              epo:hasPublicationDate ?NoticePublicationDate;
              epo:refersToLot ?Lot.

** Defining lot and lot award outcome according to EPO ontology

    ?Lot a epo:Lot.
    ?LotAwardOutcome epo:describesLot ?Lot;
                     a epo:LotAwardOutcome;
                     epo:comprisesTenderAwardOutcome ?TenderAwardOutcome.
    ?TenderAwardOutcome a epo:TenderAwardOutcome;
                        epo:indicatesAwardOfLotToWinner / epo:playedBy ?Winner.

** Defining the winner according to EPO ontology

    ?Winner a org:Organization;
            epo:hasLegalName ?WinnerLegalName .
    OPTIONAL {
        ?Winner cccev:registeredAddress / epo:hasCountryCode ?WinnerCountryCode.
    }

** Defining award value and currency according to EPO ontology

    ?LotAwardOutcome epo:hasAwardedValue ?LotAwardedValue.
    ?LotAwardedValue a epo:MonetaryValue;
                     epo:hasAmountValue ?AwardedValue;
                     epo:hasCurrency ?AwardedValueCurrency.


The query retrieves:

* Lot URI
* The legal name of the winner
* The winners country code as URI
* The value awarded to winner
* The currency of the awarded value

The notice publication date and winner legal name language can be changed to create other queries. To do this, change the following section:


    VALUES ?NoticePublicationDate {
        "20230921"
    }
    FILTER(LANG(?WinnerLegalName) = 'en')

* Existing value for publication date in example above:

 "20230921"

* Existing value for winner legal name language in example above:

 'en'

=== Query text:

[source,sparql]
PREFIX epo: <http://data.europa.eu/a4g/ontology#>
PREFIX org: <http://www.w3.org/ns/org#>
PREFIX cccev: <http://data.europa.eu/m8g/>
SELECT
?Lot
?WinnerLegalName
?WinnerCountryCode
?AwardedValue
?AwardedValueCurrency
WHERE {
    VALUES ?NoticePublicationDate {
        "20230905"
    }
    FILTER(LANG(?WinnerLegalName) = 'en')
    ?Notice epo:hasPublicationDate ?NoticePublicationDate ;
            epo:refersToLot ?Lot .
    ?LotAwardOutcome epo:describesLot ?Lot ;
                     epo:hasAwardedValue ?MonetaryValue ;
                     epo:comprisesTenderAwardOutcome ?TenderAwardOutcome.
    ?TenderAwardOutcome a epo:TenderAwardOutcome;
                        epo:indicatesAwardOfLotToWinner / epo:playedBy ?Winner.
    ?Winner a org:Organization;
            epo:hasLegalName ?WinnerLegalName .
    OPTIONAL {
        ?Winner cccev:registeredAddress / epo:hasCountryCode ?WinnerCountryCode.
    }
    ?MonetaryValue a epo:MonetaryValue;
                   epo:hasAmountValue ?AwardedValue;
                   epo:hasCurrency ?AwardedValueCurrency .
}
ORDER BY DESC(?AwardedValue)
LIMIT 1


include::partial$feedback.adoc[]
